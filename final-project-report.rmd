---
title: 'Correlation of Location, Year, Economic Status, and Demographic Information with Suicide Rate'
author: "STAT 420, Summer 2020, Kun Hu, Madeline Old, Yuwen Xiang, Patrick Willhalm"
date: '07/18/2020'
output:
  pdf_document: 
    latex_engine: xelatex
  html_document: 
    theme: readable
    toc: yes  
urlcolor: cyan
---


***
# Introduction

This file compares the number of suicides per 100,000 across categories stratified by age group, sex, country, and year. There are 27820 observations across 12 variables. Variables include:

* country
* year
* sex
* age group
* number of suicides  
* population
* suicides per 100k people
* Human Development Index (HDI)
* Gross Domestic Product (GDP)
* GDP per capita


This dataset is a compilation of data from the UN Development Program, World Bank, and the World Health Organization. We found the data online at [https://www.kaggle.com/russellyates88/suicide-rates-overview-1985-to-2016](https://www.kaggle.com/russellyates88/suicide-rates-overview-1985-to-2016)

Suicide is unique as a public health issue in that it is 100% preventable. Stopping deaths from cancer requires developing new cancer drugs, but suicide is a social and economic rather than technical problem. Here we intend to find the correlation among different social status (includes year, sex and age) and the economic situation with the suicide rate with an eye toward suicide prevention. Depending on social status, we may find some causal links with suicide risk.

# Methods

## Load packages and the data
```{r setup, echo <- FALSE, message <- FALSE, warning <- FALSE}
library(tidyverse)
library(knitr)
library(faraway)
library(ggpubr)

options(scipen = 1, digits = 4, width = 80)
opts_chunk$set(cache = TRUE, autodep = TRUE)

suicide <- read.csv('master.csv') %>%
  as_tibble(.)
```

## Define functions for statistical tests
```{r, warning=FALSE}
bp_test_decision = function(model, alpha){
  decide = unname(bptest(model)$p.value < alpha)
  ifelse(decide, "Reject", "Fail to Reject")
}

shapiro_test_decision = function(model, alpha){
  decide = unname(shapiro.test(resid(model))$p.value < alpha)
  ifelse(decide, "Reject", "Fail to Reject")
}

cooks_distance_inf = function(model){
  mods_cd = cooks.distance(model)
  ifelse(mods_cd > 4/length(resid(model)), "Influential", "Not influential")
}

calc_loocv_rmse = function(model){
  sqrt(mean((resid(model) / (1 - hatvalues(model))) ^ 2))
}

calc_rmse = function(actual, predicted) {
  sqrt(sum((actual - predicted)^2) / length(actual)) 
}

get_t_pval = function(model){
  summary(model)$coefficients[,"Pr(>|t|)"]
}

get_f_pval = function(model1, model2){
  anova(model1, model2)[2,"Pr(>F)"]
}

get_adj_r2 = function(model){
  summary(model)$adj.r.squared
}

get_r2 = function(model){
  summary(model)$r.squared
}

get_all <- function(model) {
  bp <- bp_test_decision(model, 0.05)
  shaprio <- shapiro_test_decision(model, 0.05)
  cook <- cooks_distance_inf(model)
  loocv <- calc_loocv_rmse(model)
  r2 <- get_r2(model)
  r2_adj <- get_adj_r2(model)
  
  results <- data.frame("BP test decision" = bp,
                        "Shapiro test decision" = shaprio,
                        "Cook's Distance" = cooks,
                        "LOOCV RMSE" = loocv,
                        "R-squared" = r2,
                        "Adjusted R-squared" = r2_adj)
  
  return(results)
}

'%!in%' <- function(x,y)!('%in%'(x,y))

qq_plot <- function(model, pcol = 'grey', lcol = 'dodgerblue') {
  p1 <- ggplot() +
    geom_point(aes(x = fitted(model), y = resid(model)), color = pcol) +
    geom_hline(yintercept = 0, color = lcol) +
    labs(x = "Fitted", y = "Residuals", title = "Fitted versus Residuals") +
    theme_light()
  
  p2 <- ggplot(data.frame(y = resid(model)), aes(sample = y)) + 
    stat_qq(color = pcol) + 
    stat_qq_line(color = lcol) +
    labs(x = "Theoretical", y = "Sample", title = "Normal Q-Q Plot") +
    theme_light()
  
  ggarrange(p1, p2, ncol = 2)
}
```

## Data cleaning
```{r}
n <- nrow(suicide)
buffer <- rep(0, n)

sex <- buffer
sex[suicide$sex == 'male'] <- 1

age <- buffer
age[suicide$age == '5-14 years'] <- 10
age[suicide$age == '15-24 years'] <- 20
age[suicide$age == '25-34 years'] <- 30
age[suicide$age == '35-54 years'] <- 45
age[suicide$age == '55-74 years'] <- 65
age[suicide$age == '75+ years'] <- 85

suicide <- suicide %>%
  select(-one_of('age', 'sex')) %>%
  add_column(age, sex) %>%
  rename(gdp_year = gdp_for_year...., 
         gdp_per_capita = gdp_per_capita...., 
         country = Ã¯..country, 
         hdi_year = HDI.for.year)

suicide$suicide_year <- buffer
suicide$suicide_year_female <- buffer
suicide$suicide_year_male <- buffer
suicide$population_year <- buffer

for (country_year in unique(suicide$country.year)) {
  data_curr <- suicide[suicide$country.year == country_year,]
  
  suicide_year_curr <- sum(data_curr$suicides_no)
  suicide_year_female_curr <- sum(data_curr[data_curr$sex == 0,]$suicides_no)
  suicide_year_male_curr <- sum(data_curr[data_curr$sex == 1,]$suicides_no)
  population_year_curr <- sum(data_curr[data_curr$sex == 1,]$population)
  
  suicide[suicide$country.year == country_year,]$suicide_year <- suicide_year_curr
  suicide[suicide$country.year == country_year,]$suicide_year_female <- suicide_year_female_curr
  suicide[suicide$country.year == country_year,]$suicide_year_male <- suicide_year_male_curr
  suicide[suicide$country.year == country_year,]$population_year <- population_year_curr
}

suicide$gdp_year = as.numeric(gsub(",", "", suicide$gdp_year))

head(suicide)
```

## Pre-analysis
```{r}
par(mfrow = c(2,3))
hist(suicide$suicides_no, breaks = 20, main = "Number of suicide",border="darkorange", col="dodgerblue")
hist(suicide$population, breaks = 20, main = "Population",border="darkorange", col="dodgerblue")
hist(suicide$suicides.100k.pop, breaks = 20, main = "Suicides per 100k people",border="darkorange", col="dodgerblue")

## Pie plot
hist(suicide$age, breaks = 20, main = "Age group",border="darkorange", col="dodgerblue")
hist(as.numeric(suicide$generation), breaks = 20, main = "Generation",border="darkorange", col="dodgerblue")
hist(as.numeric(suicide$sex), breaks = 10, main = "Sex",border="darkorange", col="dodgerblue")

## Trends with year (suicide number and GDP)


suicide %>%
  select(one_of('year', 'suicide_no', 'population', 'suicides.100k.pop', 'gdp_year', 'gdp_per_capita')) %>%
  pairs(col = 'darkorange')

plot(log(suicide$gdp_per_capita), suicide$hdi_year)
```


```{r}
df_suicide_gdp <- suicide %>%
  distinct(country.year, .keep_all = TRUE)

ggplot(df_suicide_gdp) +
  geom_point(aes(x = gdp_per_capita, y = suicide_year))

ggplot(df_suicide_gdp) +
  geom_point(aes(x = gdp_year, y = suicide_year))

list_year = sort(unique(df_suicide_gdp$year))
suicide_by_year <- c()
for (year in list_year) {
  suicide_by_year[length(suicide_by_year) + 1] <- sum(df_suicide_gdp[df_suicide_gdp$year == year,]$suicide_year)
}

ggplot() +
  geom_line(aes(x = list_year, y = suicide_by_year))
```

## Modelling
```{r}
suicide$sex = as.factor(suicide$sex)
suicide$generation = as.factor(suicide$generation)

m0_suicide <- lm(suicides.100k.pop ~ population + gdp_year + age + sex + log(gdp_per_capita), data = suicide)

m0_suicide_aic <- step(m0_suicide, trace = 0)

m1_suicide <- lm(suicides.100k.pop ~ (population + gdp_year + age + sex + log(gdp_per_capita)) ^ 5, data = suicide)

m1_suicide_aic <- step(m1_suicide, trace = 0)

m2_suicide <- lm(suicides.100k.pop ~ (population + gdp_year + age + sex + log(population) + log(gdp_year) + log(age)) ^ 2, data = suicide)

m2_suicide_aic <- step(m2_suicide, trace = 0)

m3_suicide <- lm(suicides.100k.pop ~ I(population ^ -1) + gdp_year + age + sex + log(gdp_per_capita), data = suicide)

m3_suicide_aic <- step(m0_suicide, trace = 0, k = log(n), direction = 'backward')

model1 = lm(suicides.100k.pop ~ suicides_no + hdi_year + gdp_year + generation + age + sex + population, data = suicide)
selected1 = step(model1, direction = "backward", trace = FALSE)

#so far it is the best one
model2 = lm(suicides.100k.pop ~ suicides_no * hdi_year * gdp_year * generation * age * sex * population, data = suicide)
selected2 = step(model2, direction = "backward", trace = FALSE)

model3 = lm(suicides.100k.pop ~ gdp_per_capita * age * sex, data = suicide )
selected3 = step(model3, direction = "backward", trace = FALSE)

model4 = lm(suicides.100k.pop ~ sex * age * gdp_per_capita * generation, data = suicide)
selected4 = step(model4, direction = "backward", trace = FALSE)

vif(m0_suicide)
```


```{r}


m_hdi_gdp <- lm(hdi_year ~ log(gdp_per_capita), data = suicide)
summary(m_hdi_gdp)$adj.r.squared
```

```{r}


qq_plot(m3_suicide)
```


# Results

# Discussion

# Appendix





